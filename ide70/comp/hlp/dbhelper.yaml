---
unitInterface:
  descr: DB helper
  events:
    saveData:
      descr: Call this event handler to save form data
    afterSaveData:
      descr: Called after saveData, place post save actions here
  properties:
    dbIdInputName:
      descr: Name of input parameter holding database entity id
      valueCompleter:
        yamlPathCompleter:
          self: yes
          pathExpr: "[0].inputs.%"
    tableName:
      descr: Name of database table
      valueCompleter:
        fileNameCompleter:
          folderPrefix: dcfg/schema
          trimSuffix: .yaml
    dataObject:
      descr: Data object when updating data
injectToUnit:
  initialEventList:
    - onDBOLoad
    - onDataLoad
    - onUnitCreate
injectToComp:
  - filter:
      hasProp: store
    defs:
      eventHandlers:
        onDataLoad:
          action: |
            var crDbHelper = CompCtx().GetUnit().GetProp("crDbHelper");
            var dbHelper = CompByCr(crDbHelper);
            var dbo = dbHelper.GetPropToCast("dataObject").AsDBO();
            if(dbo) {
                CompCtx().InitializeStored(dbo.GetData());
            }
copyPropertyToUnit:
  - srcProp: cr
    dstProp: crDbHelper
eventHandlers:
  onDBOLoad:
    action: |
      var dbIdInputName = CompCtx().GetProp("dbIdInputName");
      var dbTableName = CompCtx().GetProp("tableName");
      Api().Logger().Info("passParams", Event().GetUnit().GetPassParams());
      var dbId = Event().GetUnit().GetPassParams().Get(dbIdInputName);
      Api().Logger().Info("dbId", dbId);
      if(dbId) {
            var dbo = Event().DBCtx().FindDBO(dbTableName, dbId);
            if(dbo) {
                //Event().GetUnit().InitializeStored(dbo.GetData());
                CompCtx().SetProp("dataObject", dbo);
            }
      }
  saveData:
    action: |
      var formData = Event().GetUnit().CollectStored();
      var dbo = CompCtx().GetPropToCast("dataObject").AsDBO();
      var dbTableName = CompCtx().GetProp("tableName");
      if(dbo) {
        dbo.UpdateData(formData);
      } else {
        dbo = Event().DBCtx().CreateDBO(formData, dbTableName);
      }
      dbo.Save();
      CompCtx().ForwardEvent("afterSaveData");
  afterSaveData:
    action: |
      "";
